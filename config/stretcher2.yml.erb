default: &default
  pre:
    -
  post:
  success:
    -
  failure:
    - cat >> /tmp/failure
web:
  <<: *default
  post:
    - ln -nfs <%= deploy_to %>/releases/<%= time_now %> <%= deploy_to %>/current
    - rm -rf <%= deploy_to %>/current/log
    - ln -nfs <%= deploy_to %>/shared/log <%= deploy_to %>/current/log
    - mkdir -p <%= deploy_to %>/current/tmp
    - ln -nfs <%= deploy_to %>/shared/pids <%= deploy_to %>/current/tmp/pids
    - ln -nfs <%= deploy_to %>/shared/data <%= deploy_to %>/current/data
    - chown app. <%= deploy_to %>/current/ -R
    - systemctl reload unicorn || systemctl start unicorn
    - bundle exec rake db:create
    - bundle exec rake db:migrate
batch:
  <<: *default
  post:
    - ln -nfs <%= deploy_to %>/releases/<%= time_now %> <%= deploy_to %>/current
    - rm -rf <%= deploy_to %>/current/log
    - ln -nfs <%= deploy_to %>/shared/log <%= deploy_to %>/current/log
    - mkdir -p <%= deploy_to %>/current/tmp
    - ln -nfs <%= deploy_to %>/shared/pids <%= deploy_to %>/current/tmp/pids
    - ln -nfs <%= deploy_to %>/shared/data <%= deploy_to %>/current/data
    - chown app. <%= deploy_to %>/current/ -R
    - systemctl reload sidekiq || systemctl start sidekiq
